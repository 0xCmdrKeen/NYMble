<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NYM - Nostr Ynstant Messenger</title>
    <meta name="description" content="Ephemeral anonymous messaging over Nostr. Bridged with Bitchat geohash channels.">
    <link rel="manifest"
        href="data:application/json;base64,eyJuYW1lIjoiTllNIC0gTm9zdHIgWW5zdGFudCBNZXNzZW5nZXIiLCJzaG9ydF9uYW1lIjoiTllNIiwic3RhcnRfdXJsIjoiaHR0cHM6Ly9ueW0uYmFyLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwidGhlbWVfY29sb3IiOiIjMDAwMDAwIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMDAwMDAiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9ueW0uYmFyL2ltYWdlcy9OWU0taWNvbi5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn0seyJzcmMiOiJodHRwczovL255bS5iYXIvaW1hZ2VzL05ZTS1pY29uLnBuZyIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9wbmcifV19">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Anonymously Chat with NYM">
    <meta property="og:description"
        content="Ephemeral anonymous messaging over Nostr. Bridged with Bitchat geohash channels.">
    <meta property="og:image" content="https://nym.bar/images/NYM-icon.png">
    <meta property="og:url" content="https://nym.bar">
    <meta property="og:type" content="website">
    <link rel="icon" href="/images/NYM-icon.png" type="image/png">
    <link rel="canonical" href="https://nym.bar/">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NYM">
    <link rel="apple-touch-icon" href="/images/NYM-icon.png">

    <script type="module" src="/src/index.js"></script>
</head>

<body>
    <div class="mobile-overlay" id="mobileOverlay" onclick="nym.closeSidebar()"></div>
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">☰</button>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="ctxMention">Mention</div>
        <div class="context-menu-item lightning" id="ctxZap" style="display: none;">⚡ Zap</div>
        <div class="context-menu-item" id="ctxPM">Private Message</div>
        <div class="context-menu-item" id="ctxQuote">Quote Message</div>
        <div class="context-menu-item danger" id="ctxBlock">Block User</div>
    </div>

    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">NYM</div>
                <div class="tagline">Ephemeral Nostr Chat</div>
                <div class="nym-display" onclick="editNick()">
                    <div class="nym-label">Your Nym (click to edit)</div>
                    <div class="nym-value">
                        <span id="currentNym">anonymous</span>#<span id="nymSuffix">????</span>
                    </div>
                </div>
                <div class="status-indicator">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="connectionStatus">Disconnected</span>
                </div>
            </div>

            <div class="sidebar-actions">
                <button class="icon-btn" onclick="showChannelModal(); nym.closeSidebar();">+ Channel</button>
                <button class="icon-btn" onclick="showSettings(); nym.closeSidebar();">Settings</button>
                <button class="icon-btn" onclick="signOut(); nym.closeSidebar();" title="Logout">Logout</button>
                <button class="icon-btn" onclick="showAbout(); nym.closeSidebar();">About</button>
            </div>

            <div class="nav-section">
                <div class="nav-title">
                    <span class="nav-title-text">Channels</span>
                    <span class="search-icon" onclick="toggleSearch('channelSearch')">
                        <svg viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </span>
                </div>
                <input type="text" class="search-input" id="channelSearch" placeholder="Search channels..."
                    onkeyup="nym.handleChannelSearch(this.value)">
                <div id="channelSearchResults"></div>
                <div class="channel-list" id="channelList">
                    <div class="channel-item active" data-channel="bar" data-geohash="">
                        <span class="channel-name">#bar</span>
                        <div class="channel-badges">
                            <span class="pin-btn" onclick="event.stopPropagation(); nym.togglePin('bar', '')">
                                <svg viewBox="0 0 24 24">
                                    <path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" />
                                </svg>
                            </span>
                            <span class="std-badge">STD</span>
                            <span class="unread-badge" style="display:none">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">
                    <span class="nav-title-text">Private Messages</span>
                    <span class="search-icon" onclick="toggleSearch('pmSearch')">
                        <svg viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </span>
                </div>
                <input type="text" class="search-input" id="pmSearch" placeholder="Search PMs..."
                    onkeyup="nym.filterPMs(this.value)">
                <div class="pm-list" id="pmList"></div>
            </div>

            <div class="user-list" id="userList">
                <div class="nav-title">
                    <span class="nav-title-text">Active Nyms</span>
                    <span class="search-icon" onclick="toggleSearch('userSearch')">
                        <svg viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </span>
                </div>
                <input type="text" class="search-input" id="userSearch" placeholder="Search users..."
                    onkeyup="nym.filterUsers(this.value)">
                <div id="userListContent"></div>
            </div>
        </aside>

        <main class="main-content">
            <header class="chat-header">
                <div class="channel-info">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div>
                            <div class="channel-title" id="currentChannel">#bar</div>
                            <div class="channel-meta" id="channelMeta">0 nyms in channel</div>
                        </div>
                        <button class="share-channel-btn" id="shareChannelBtn" onclick="nym.shareChannel()"
                            title="Share channel URL">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path
                                    d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="showChannelModal()">+ Channel</button>
                    <button class="icon-btn" onclick="showSettings()">Settings</button>
                    <button class="icon-btn" onclick="signOut()" title="Logout">Logout</button>
                    <button class="icon-btn" onclick="showAbout()">About</button>
                </div>
            </header>

            <div class="messages-container" id="messagesContainer">
                <div class="system-message">
                    ═══ Booting up NYM ═══
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator"></div>

            <div class="input-container">
                <div class="input-wrapper">
                    <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
                    <div class="emoji-autocomplete" id="emojiAutocomplete"></div>
                    <div class="command-palette" id="commandPalette"></div>
                    <div class="upload-progress" id="uploadProgress">
                        <div>Uploading image...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                    <textarea class="message-input" id="messageInput" placeholder="Type a message or / for commands..."
                        rows="1" disabled></textarea>
                </div>
                <div class="input-buttons">
                    <input type="file" class="file-input" id="fileInput" accept="image/*">
                    <button class="icon-btn input-btn" onclick="selectImage()" title="Upload Image">
                        <svg viewBox="0 0 24 24">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </button>
                    <button class="icon-btn input-btn" onclick="nym.toggleEmojiPicker()" title="Emoji">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                            <circle cx="9" cy="9" r="1"></circle>
                            <circle cx="15" cy="9" r="1"></circle>
                        </svg>
                    </button>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>SEND</button>
                </div>
                <div class="emoji-picker" id="emojiPicker"></div>
            </div>
        </main>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="closeImageModal()">×</span>
        <img id="modalImage" src="" alt="Expanded image">
    </div>

    <!-- Nick Edit Modal -->
    <div class="modal nick-edit-modal" id="nickEditModal">
        <div class="modal-content">
            <div class="modal-header">Change Your Nym's nickname</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">New Nym nick</label>
                    <input type="text" class="form-input" id="newNickInput" placeholder="Enter new nym" maxlength="20">
                    <div class="form-hint">Your ephemeral pseudonym nickname for this session</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="icon-btn" onclick="closeModal('nickEditModal')">Cancel</button>
                <button class="send-btn" onclick="changeNick()">Change</button>
            </div>
        </div>
    </div>

    <!-- Initial Setup Modal -->
    <div class="modal active" id="setupModal">
        <div class="modal-content">
            <div class="modal-header">Welcome to NYM<br /><label style="color: var(--warning); margin-top:5px;"
                    class="form-label">Ephemeral, anonymous, decentralized chat</label></div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Connection Mode</label>
                    <select class="form-select" id="connectionMode">
                        <option value="ephemeral">Ephemeral (Auto-generate temporary keys)</option>
                        <option value="extension">Use Nostr Extension (Persistent identity)</option>
                        <option value="nsec">Use NSEC Private Key (Persistent identity)</option>
                    </select>
                </div>

                <!-- NSEC -->
                <div class="form-group" id="nsecGroup" style="display:none">
                    <label class="form-label">Enter your NSEC</label>
                    <input type="password" class="form-input" id="nsecInput" placeholder="nsec1...">
                    <div class="form-hint">Your private key will be stored locally</div>
                </div>

                <div class="form-group" id="nymGroup">
                    <label class="form-label">Choose Your Nym's nickname (optional)</label>
                    <input type="text" class="form-input" id="nymInput" placeholder="Leave empty for profile name"
                        maxlength="20">
                    <div class="form-hint" id="nymHint">Your ephemeral pseudonym nickname for this session</div>
                </div>

                <div
                    style="color: var(--warning); font-size: 12px; margin-top: 15px; padding: 10px; border: 1px solid var(--warning);">
                    NOTE: Channels are bridged with Bitchat geohash. Messages are
                    public and temporary; sent across the Nostr network. Your nym exists
                    only for this session and will be burned.
                </div>
            </div>
            <div class="modal-actions">
                <div class="status" style="margin: 10px" hidden>
                    Generating keypair...
                    <span class="loader"></span>
                </div>
                <button class="send-btn" onclick="initializeNym()">Enter NYM</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">Settings</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Connected Relays</label>
                    <div id="connectedRelaysList"
                        style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; background: var(--bg);">
                        <div style="color: var(--text-dim); font-size: 12px;">Loading relay list...</div>
                    </div>
                    <button class="icon-btn" onclick="nym.refreshRelays()"
                        style="margin-top: 10px; width: 100%;">Refresh Relay List</button>
                </div>

                <div class="form-group">
                    <label class="form-label">Sort Geohash Channels by Proximity</label>
                    <select class="form-select" id="proximitySelect">
                        <option value="false">Disabled</option>
                        <option value="true">Enabled (requires location access)</option>
                    </select>
                    <div class="form-hint">Sort geohash channels by distance from your location</div>
                </div>

                <div class="form-group">
                    <label class="form-label">⚡ Lightning Address</label>
                    <input type="text" class="form-input" id="lightningAddressInput"
                        placeholder="your@lightning-address.com">
                    <div class="form-hint">Your Lightning address for receiving zaps</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Theme</label>
                    <select class="form-select" id="themeSelect">
                        <option value="matrix">Matrix Green</option>
                        <option value="amber">Amber Terminal</option>
                        <option value="cyber">Cyberpunk</option>
                        <option value="hacker">Hacker Blue</option>
                        <option value="ghost">Ghost (B&W)</option>
                        <option value="bitchat">Bitchat</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Notification Sound</label>
                    <select class="form-select" id="soundSelect">
                        <option value="beep">Classic Beep</option>
                        <option value="icq">ICQ Uh-Oh</option>
                        <option value="msn">MSN Alert</option>
                        <option value="none">Silent</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Auto-scroll Messages</label>
                    <select class="form-select" id="autoscrollSelect">
                        <option value="true">Enabled</option>
                        <option value="false">Disabled</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Show Timestamps</label>
                    <select class="form-select" id="timestampSelect">
                        <option value="true">Show</option>
                        <option value="false">Hide</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Blocked Keywords/Phrases</label>
                    <input type="text" class="form-input" id="newKeywordInput"
                        placeholder="Add keyword or phrase to block">
                    <button class="icon-btn" onclick="nym.addBlockedKeyword()"
                        style="margin-top: 10px; width: 100%;">Add Keyword</button>
                    <div class="keyword-list" id="keywordList" style="margin-top: 10px;">
                        <div style="color: var(--text-dim); font-size: 12px;">No blocked keywords</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Blocked Channels</label>
                    <div class="blocked-list" id="blockedChannelsList">
                        <div style="color: var(--text-dim); font-size: 12px;">No blocked channels</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Blocked Users</label>
                    <div class="blocked-list" id="blockedList">
                        <div style="color: var(--text-dim); font-size: 12px;">No blocked users</div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="icon-btn" onclick="closeModal('settingsModal')">Cancel</button>
                <button class="send-btn" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- Channel Modal -->
    <div class="modal" id="channelModal">
        <div class="modal-content">
            <div class="modal-header">Join/Create Channel</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Channel Type</label>
                    <select class="form-select" id="channelTypeSelect">
                        <option value="standard">Standard Channel</option>
                        <option value="geohash">Location-based (Geohash)</option>
                    </select>
                </div>

                <div class="form-group" id="standardChannelGroup">
                    <label class="form-label">Channel Name</label>
                    <input type="text" class="form-input" id="channelNameInput" placeholder="random">
                    <div class="form-hint">Enter channel name without # (e.g., "random" for #random)</div>
                </div>

                <div class="form-group" id="geohashGroup" style="display:none">
                    <label class="form-label">Geohash</label>
                    <input type="text" class="form-input" id="geohashInput" placeholder="e.g., w1, dr5r, etc."
                        maxlength="12"
                        oninput="this.value = this.value.toLowerCase().replace(/[^0-9bcdefghjkmnpqrstuvwxyz]/g, '')">
                    <div class="form-hint">Enter a geohash code (valid chars: 0-9, b-z except a,i,l,o)</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="icon-btn" onclick="closeModal('channelModal')">Cancel</button>
                <button class="send-btn" onclick="joinChannel()">Join</button>
            </div>
        </div>
    </div>

    <!-- Zap Modal -->
    <div class="modal zap-modal" id="zapModal">
        <div class="modal-content">
            <div class="modal-header">⚡ Send Lightning Zap</div>
            <div class="modal-body">
                <div id="zapRecipientInfo" style="text-align: center; margin-bottom: 20px; color: var(--text-dim);">
                </div>

                <div id="zapAmountSection">
                    <div class="form-group">
                        <label class="form-label">Select Amount</label>
                        <div class="zap-amounts">
                            <button class="zap-amount-btn" data-amount="21">
                                <span class="sats">21</span>
                                sats
                            </button>
                            <button class="zap-amount-btn" data-amount="100">
                                <span class="sats">100</span>
                                sats
                            </button>
                            <button class="zap-amount-btn" data-amount="500">
                                <span class="sats">500</span>
                                sats
                            </button>
                            <button class="zap-amount-btn" data-amount="1000">
                                <span class="sats">1K</span>
                                sats
                            </button>
                            <button class="zap-amount-btn" data-amount="5000">
                                <span class="sats">5K</span>
                                sats
                            </button>
                            <button class="zap-amount-btn" data-amount="10000">
                                <span class="sats">10K</span>
                                sats
                            </button>
                        </div>
                    </div>

                    <div class="form-group zap-custom-amount">
                        <input type="number" class="form-input" id="zapCustomAmount" placeholder="Custom amount (sats)"
                            min="1">
                    </div>

                    <div class="form-group zap-comment">
                        <label class="form-label">Comment (optional)</label>
                        <input type="text" class="form-input" id="zapComment" placeholder="Add a comment to your zap">
                    </div>
                </div>

                <div id="zapInvoiceSection" style="display: none;">
                    <div class="zap-status checking" id="zapStatus">
                        <span class="loader"></span> Generating invoice...
                    </div>

                    <div id="zapInvoiceDisplay" style="display: none;">
                        <div class="zap-invoice-qr" id="zapQRCode"></div>
                        <div class="zap-invoice" id="zapInvoice"></div>
                        <div class="zap-invoice-actions">
                            <button class="icon-btn" onclick="nym.copyZapInvoice()" style="flex: 1;">Copy
                                Invoice</button>
                            <button class="icon-btn" onclick="nym.openInWallet()" style="flex: 1;">Open Wallet</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="icon-btn" onclick="nym.closeZapModal()">Cancel</button>
                <button class="send-btn" id="zapSendBtn" onclick="nym.generateZapInvoice()">Generate Invoice</button>
            </div>
        </div>
    </div>

    <!-- Share Channel Modal -->
    <div class="modal" id="shareModal">
        <div class="modal-content share-modal">
            <div class="modal-header">Share Channel</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Channel URL</label>
                    <div class="share-url-container">
                        <input type="text" class="share-url-input" id="shareUrlInput" readonly>
                        <button class="copy-url-btn" onclick="nym.copyShareUrl()">COPY</button>
                    </div>
                    <div class="form-hint">Share this URL to invite others to this channel</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="icon-btn" onclick="closeModal('shareModal')">Close</button>
            </div>
        </div>
    </div>
</body>

</html>